#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# Define a function to install a package
install_package() {
    local package_name=$1
    local check_command=$2

    # Check if package is already installed
    if command -v "$check_command" >/dev/null 2>&1; then
        echo "$package_name is already installed."
        return 0
    fi

    echo "Installing $package_name..."
    
    # First try with pacman
    if pacman -Si "$package_name" >/dev/null 2>&1; then
        sudo pacman -S --noconfirm "$package_name"
    # If not in pacman, try with yay (AUR helper)
    elif command -v yay >/dev/null 2>&1 && yay -Si "$package_name" >/dev/null 2>&1; then
        yay -S --noconfirm "$package_name"
    else
        echo "Warning: Package $package_name not found in pacman or AUR repositories."
        return 1
    fi
}

echo "Arch Linux detected. Installing packages..."

# Install packages
install_package "npm" "npm"
install_package "fnm" "fnm"
install_package "starship" "starship"
install_package "atuin" "atuin"
install_package "zsh" "zsh"
install_package "tig" "tig"
install_package "yazi" "yazi"
install_package "zoxide" "zoxide"
install_package "udiskie" "udiskie"
install_package "neovim" "nvim"
install_package "firefox" "firefox"
install_package "google-chrome" "google-chrome"
install_package "brave-bin" "brave-bin"
install_package "p7zip" "7z"  # Note: Changed from 7zip to p7zip

# Install nodejs dependencies using fnm
if command -v fnm >/dev/null 2>&1; then
    echo "Setting up Node.js with fnm..."
    fnm install 22
    # Source fnm to make it available in the current shell
    eval "$(fnm env)"
    
    # Install pnpm and language servers
    npm install -g pnpm
    npm install -g vscode-langservers-extracted
    npm install -g typescript-language-server
else
    echo "Warning: fnm not available, skipping Node.js setup"
fi

echo "Installation script finished."
